<html>
  <head>
    <title>Ingestion Job Report</title>

    <link rel="stylesheet" type="text/css" href="report.css" />
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript">

      var API_URL = 'http://localhost:8080';
      //var API_URL = 'http://devgalactus.slidev.org:9090/';
      var MONGO_HOST_PORT = null; // defaults and set in html input
      
      google.load('visualization', '1', {'packages':['corechart']});

      google.setOnLoadCallback(listJobs);

      var jobCache = {};

      function listJobs() {
        $('#job_chooser').empty();
        $('#job_chooser_toggle').empty();
        clearJobSpecificDivs();

        MONGO_HOST_PORT = $('#mongo_host').val(); // initialize
        
        var jobs = getApiResource('/jobids');

        if (jobs != null) {
          $('#job_chooser_toggle')
            .append('<h4>' + jobs.length + ' Available Jobs (<a href="#" onclick="toggleJobChooser()">show/hide</a>):');

          $.each(jobs, function(key, val) {
            $('#job_chooser')
              .append('<input type="checkbox" class="job_checkbox" name="'+val._id+'" />')
              .append('<a href="#" onclick="jobSummary(\''+val._id+'\')">'+val._id+'</a> '+val.jobStartTimestamp+'<br/>');
          });

          $('#job_chooser')
            .append('<input type="button" name="select" value="Select" onclick="jobCompare()">');
        }
      }

      function jobSummary(jobId) {
        $('#job_chooser').hide('slow'); // hide the job chooser as it can be huge

        clearJobSpecificDivs();
        $('#job_summary').append('<h4>Job Summary: ' + jobId + '</h4>');

        var job = getApiResource('/job/' + jobId);

        var recordCount = getRecordCountForJob(job);
        job.recordCount = recordCount;

        var startDate = new Date(job.jobStartTimestamp);
        var stopDate = new Date(job.jobStopTimestamp);
        var jobTime = (stopDate.getTime() - startDate.getTime()) / 1000;

        var hours = Math.floor(jobTime / 3600);
        var min_divisor = jobTime % (3600);
        var minutes = Math.floor(min_divisor / 60);
        var sec_divisor = min_divisor % 60;
        var seconds = Math.ceil(sec_divisor);
        var jobTimeDisplay = hours + ':' + minutes + ':' + seconds;

        $('#job_summary')
          .css({'color': 'white'})
          .append('Job Status: ' + job.status + '<br/>')
          .append('EdFi Record Count: ' +recordCount + '<br/>')
          .append('Total Job Time: ' + jobTimeDisplay + '<br/>')
          .append('Total Job RPS: ' + (recordCount / jobTime).toFixed(2) + '<br/>');

        var errors = getApiResource('/job/' + jobId + '/error');
        $('#job_summary').append('Errors: ' + errors.length);

        drawStageBreakdownPieChart(job);

        drawEntityPerformanceCharts(job);
      }

      function drawStageBreakdownPieChart(job) {
        var dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', 'Stage Name');
        dataTable.addColumn('number', 'Elapsed Time');

        $.each(job.stages, function(key, stage) {
          var elapsedSeconds = stage.elapsedTime/1000;
          var stageSummary = stage.stageName + ' ' + elapsedSeconds + 's ' + Math.ceil(job.recordCount / elapsedSeconds) + 'rps';

          dataTable.addRow([stageSummary, stage.elapsedTime]);
        });
        
        drawPieChart(dataTable);
      }

      function drawEntityPerformanceCharts(job) {
        var entityStatsMap = {};
        // ex. [{ 'PersistenceProcessor': { 'assessment': {'recordCount': 123, 'elapsedTime': 456, 'displayLabel': 'somestring'} } }];
        
        var stagesForJob = getApiResource('/job/' + job._id + '/stage');

        $.each(stagesForJob, function(key, stage) {
          //Need to handle those records without processingInformation
          if(typeof (stage.processingInformation) != 'undefined') {
            if (typeof entityStatsMap[stage.stageName] == 'undefined') {
              entityStatsMap[stage.stageName] = {}; // init
            }

            var entity = stage.processingInformation.split(",")[0].split("=")[1];
            if (typeof entity != 'undefined') {
              if (entityStatsMap[stage.stageName][entity] == null) {
                entityStatsMap[stage.stageName][entity] = {'recordCount': 0, 'elapsedTime': 0}; // init
              }

              $.each(stage.metrics, function(key, metric) {
                entityStatsMap[stage.stageName][entity].recordCount += metric.recordCount;
              });
              entityStatsMap[stage.stageName][entity].elapsedTime += stage.elapsedTime;
            }
          }
        });

        // construct, populate, and draw google DataTables
        $.each(entityStatsMap, function(key, entityStat) {
          if (key == 'TransformationProcessor' || key == 'PersistenceProcessor') {
            var dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Entity');
            dataTable.addColumn('number', 'Record Count');
            dataTable.addColumn('number', 'Elapsed Time');

            $.each(entityStat, function(key, entity) {
              // add rps info to each entity displayLabel
              if (typeof entity.recordCount == 'number' && typeof entity.elapsedTime == 'number') {
                entity.rps = Math.ceil(entity.recordCount / (entity.elapsedTime/1000));
                entity.displayLabel = key + ' (' + entity.recordCount + '/' + (entity.elapsedTime/1000) + ') = ' + entity.rps;
              }
              dataTable.addRow([entity.displayLabel, entity.recordCount, entity.elapsedTime]);
            });
            dataTable.sort([{column: 2, desc:true}, {column:1, desc:true}]); // sort by elapsed time, descending
            drawBarChart(key, key + '_entity_div', dataTable);
          }
        });
      }

      // cross-job comparison
      function jobCompare() {
        clearJobSpecificDivs();
        $('#job_chooser').hide('slow'); // hide the job chooser as it can be huge

        drawJobCompareStageChart(); // chart that compares the jobs' stages with one another

        drawJobCompareEntityCharts(); // charts that compare the jobs' entities with one another
      }

      function drawJobCompareStageChart() {
        var stageNames = []; // ex. stage1,stage2,etc
        var comparedJobsStageStats = []; // ex. [{ 'jobId': 123, 'stageStats': [{'EdFiProcessor':123}] }]

        // prepare the data into the stageNames and comparedJobsStageStats data structures
        $('.job_checkbox').each(function(key, jobCheckbox) {
          if (jobCheckbox.checked) {
            var job = getJob(jobCheckbox.name);

            var recordCount = getRecordCountForJob(job);

            var statsMap = {'jobId': job._id, 'stageStats': {}};

            $.each(job.stages, function(key, stage) {
              if (stageNames.indexOf(stage.stageName) == -1) {
                stageNames.push(stage.stageName);
              }
              var rps = -1;
              if (stage.elapsedTime != null && stage.elapsedTime > 0) {
                rps = recordCount / (stage.elapsedTime/1000);
              }
              statsMap.stageStats[stage.stageName] = rps;
            });
            comparedJobsStageStats.push(statsMap);
          }
        });

        // construct and populate google DataTable
        var compareJobStageDataTable = new google.visualization.DataTable();

        // add columns
        compareJobStageDataTable.addColumn('string', 'Job Id'); // 1st col is job id
        $.each(stageNames, function(key, stageName) {
          compareJobStageDataTable.addColumn('number', stageName); // other cols are stage names
        });

        // add rows
        $.each(comparedJobsStageStats, function(key, jobStageStat) {
          var row = [jobStageStat.jobId];
          $.each(stageNames, function(key, stageName) {
            row.push(jobStageStat.stageStats[stageName]);
          });
          compareJobStageDataTable.addRow(row);
        });

        drawComboChart('Cross Job Stage Breakdown', 'RPS', 'Job Id', 'stage_breakdown_linechart_div', compareJobStageDataTable);
      }

      function drawJobCompareEntityCharts() {
        var entityPersistencePerf = [ ['BatchJob'] ];
        var entityXformPerf = [ ['BatchJob'] ];        

        $('.job_checkbox').each(function(key, jobCheckbox) {
          if (jobCheckbox.checked) {
            
            var job = getJob(jobCheckbox.name);

            calXformPersistence(entityPersistencePerf, entityXformPerf, job);
          }
        });

        normalization(entityPersistencePerf);
        normalization(entityXformPerf);

        drawComboChart('Cross Job Persistence Entity Performance', 'RPS', 'BatchJob', 'entity_persistence_linechart_div', new google.visualization.arrayToDataTable(entityPersistencePerf));
        drawComboChart('Cross Job Transformation Entity Performance', 'RPS', 'BatchJob', 'entity_xform_linechart_div', new google.visualization.arrayToDataTable(entityXformPerf));
      }
      
      function calXformPersistence(entityPersistencePerf, entityXformPerf, job) {
        var PXTRes = getTransformPersistChartData(job);
        var PerElem = [job._id];
        var XformElem = [job._id];
        var processorChartMap = {
          'persistenceChartData': entityPersistencePerf,
          'transformationChartData': entityXformPerf
        };
        var processingChartElem = {
          'persistenceChartData': PerElem,
          'transformationChartData': XformElem
        };
        for (var processor in PXTRes) {
          var perf = processorChartMap[processor];
          var entities;
          if (PXTRes.hasOwnProperty(processor)) {
            entities = PXTRes[processor];

            if (entities.length == 0) 
              continue;

            for (var entityI = 1; entityI < entities.length; entityI++) {
              var entity = entities[entityI][0].split(' ')[0];
              var index = perf[0].indexOf(entity);

              if (index == -1) {
                perf[0].push(entity);
                index = perf[0].indexOf(entity);
              }

              if (entities[entityI][1] != 0) {
                processingChartElem[processor][index] = entities[entityI][1] / (entities[entityI][2] / 1000);
              } else {
                processingChartElem[processor][index] = 0;
              }
            }
          }
        }
        entityPersistencePerf.push(PerElem);
        entityXformPerf.push(XformElem);
      }

      function drawPieChart(dataTable) {
        var chartOptions = {
          pieSliceText: 'percent',
          sliceVisibilityThreshold: 0, // zero, otherwise it groups small slices into one
          width : 1500,
          height: 600,
          chartArea: { left:0, top:0, width:"100%", height:"100%"},
          legend: { textStyle: { color: '#eecc88' }},
          backgroundColor: '#333333',
          is3D: 'true'
        };

        var chart = new google.visualization.PieChart(document.getElementById('stage_breakdown_piechart_div'));
        chart.draw(dataTable, chartOptions);
      }

      function drawBarChart(myTitle, div, dataTable) {
        var chartOptions = {
          title: myTitle,
          titleTextStyle: { color: '#eecc88' },
          fontName: 'Arial Narrow',
          series: [{color:'#4466ff'},{color:'#ee0077'}],
          chartArea: {left: 0, width: '90%', height: '95%'},
          legend: {position: 'right', alignment: 'start', textStyle: { color: '#eecc88' }},
          hAxis: {textPosition: 'out', gridlines: { count: 0 }, textStyle: { color: 'white' } }, 
          vAxis: {textPosition: 'in', textStyle: { color: 'white' }},
          width : 1500,
          height : 1200,
          backgroundColor: '#333333'
        };
        var persistenceChart = new google.visualization.BarChart(document.getElementById(div));
        persistenceChart.draw(dataTable, chartOptions);
      }

      function drawComboChart(myTitle, vTitle, hTitle, div, dataTable) {
        var chartOptions = {
          title : myTitle,
          titleTextStyle: { color: '#eecc88' },
          vAxis: {title: vTitle, textStyle: { color: 'white' }, titleTextStyle: { color: '#eecc88' }, baseline: 0, baselineColor: 'white' },
          hAxis: {title: hTitle, textStyle: { color: 'white' }, titleTextStyle: { color: '#eecc88' }, slantedText: 'true', slantedTextAngle: 45 },
          seriesType: "lines",
          pointSize: 3,
          lineWidth: 1,
          width : 1500,
          height: 600,
          legend: { textStyle: { color: '#eecc88' }},
          backgroundColor: '#333333'
        };

        var chart = new google.visualization.ComboChart(document.getElementById(div));
        chart.draw(dataTable, chartOptions);
      }

      function getJob(jobId) {
        var job = jobCache[jobId];
        if (job == null) {
          job = getApiResource('/job/' + jobId);
        }
        return job;
      }

      function getApiResource(url) {
        var jsonData = $.ajax({
          url: API_URL + url,
          type: 'GET',
          headers: { 'X-Api-Version': MONGO_HOST_PORT },
          dataType: 'json',
          async: false
        }).responseText;
        return jQuery.parseJSON(jsonData);
      }

      function getRecordCountForJob(job) {
        var recordCount = 0;
        $.each(job.stages, function(key, val) {
          if (val.stageName == 'EdFiProcessor') {
            $.each(val.metrics, function(metricsKey, metricsVal) {
              recordCount += metricsVal.recordCount;
            });
          }
        });
        return recordCount;
      }

      //Normalize the data, in case users compare batch jobs with difference entities
      function normalization(data) {
        var length = data[0].length;
        for (var i = 1; i < data.length; i++) {
          var diff = length - data[i].length;
          while (diff > 0) {
            data[i].push(0);
            --diff;
          }
        }
      }

      function clearJobSpecificDivs() {
        $('#job_summary').empty();
        $('#stage_breakdown_piechart_div').empty();
        $('#stage_breakdown_linechart_div').empty();
        $('#PersistenceProcessor_entity_div').empty();
        $('#TransformationProcessor_entity_div').empty();
        $('#entity_persistence_linechart_div').empty();
        $('#entity_xform_linechart_div').empty();
      }

      function toggleJobChooser() {
        if($('#job_chooser').is(':visible')) {
          $('#job_chooser').hide('slow');
        } else {
          $('#job_chooser').show('slow');
        }
      }

    </script>
    </head>
    <body>
        <div id="mongo_chooser">
          <form onsubmit='listJobs();return false;'>
            (mongo_host:port) <input id="mongo_host" type="text" value="localhost:27017" size="30"/>
            <input type='submit'/>
          </form>
        </div>
        <div id="job_chooser_toggle"></div>
        <div id="job_chooser"></div>
        <div id="stage_breakdown_linechart_div"></div>
        <div id="job_summary"></div>
        <div id="stage_breakdown_piechart_div"></div>
        <div id="PersistenceProcessor_entity_div"></div>
        <div id="TransformationProcessor_entity_div"></div>
        <div id="entity_persistence_linechart_div"></div>
        <div id="entity_xform_linechart_div"></div>
    </body>
</html>
