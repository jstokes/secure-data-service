<html>
  <head>
    <title>Ingestion Job Report</title>
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript">

        var API_URL = 'http://localhost:8080';
        
        // Load the Visualization API and the piechart package.
        google.load('visualization', '1', {'packages':['corechart','treemap']});
          
        // Set a callback to run when the Google Visualization API is loaded.
        google.setOnLoadCallback(listJobs);

        function getApiResource(url) {
          var jsonData = $.ajax({
            url: url,
            dataType:"json",
            async: false
          }).responseText;
          return jQuery.parseJSON(jsonData);
        }

        function listJobs() {

          var jobs = getApiResource('http://localhost:8080/job');

          $.each(jobs, function(key, val) {
            $('#job_chooser').append('<a href="#" onclick="jobSummary(\''+val._id+'\')">'+val._id+'</a><br/>');
          });
        }

        function jobSummary(jobId) {
          $('#job_summary').empty().append('<h4>Job Summary: ' + jobId + '</h4>');

          var job = getApiResource(API_URL + '/job/' + jobId);

          var recordCount = getRecordCountForJob(job);

          var startDate = new Date(job.jobStartTimestamp);
          var stopDate = new Date(job.jobStopTimestamp);
          var jobTime = (stopDate.getTime() - startDate.getTime()) / 1000;

          $('#job_summary')
            .append('Job Status: ' + job.status + '<br/>')
            .append('EdFi Record Count: ' +recordCount + '<br/>')
            .append('Total Job Time: ' + jobTime  + ' seconds.' + '<br/>')
            .append('Total Job RPS: ' + (recordCount / jobTime).toFixed(2) + '<br/>');

          var errors = getApiResource(API_URL + '/job/' + jobId + '/error');
          $('#job_summary')
            .append('Errors: ' + errors.length);

          drawStageBreakdownPieChart(job);

          //drawStageBreakdownTreeMap(job);

          drawTransformPersistChars(job);

        }

        function getRecordCountForJob(job) {
          var recordCount = 0;
          $.each(job.stages, function(key, val) {
            if (val.stageName == 'EdFiProcessor') {
              $.each(val.metrics, function(metricsKey, metricsVal) {
                recordCount += metricsVal.recordCount;
              });
            }
          });
          return recordCount;
        }

        function drawStageBreakdownPieChart(job) {
          var chartData = { 
            'cols': [ 
              { label: 'Stage Name', type: 'string'},
              { label: 'Elapsed Time', type: 'number'}
            ],
            'rows': []
          };

          $.each(job.stages, function(key, val) {
            chartData.rows.push( { c:[ {v: val.stageName}, {v: val.elapsedTime, f: val.elapsedTime/1000 + ' seconds.' } ] });
          });

          var dataTable = new google.visualization.DataTable(chartData);
          var chartOptions = {
            title: 'Stage Breakdown: ' + job._id,
            pieSliceText: 'label',
            sliceVisibilityThreshold: 0,
            width: 1024,
            height: 768,
            chartArea:{left:0,top:0,width:"100%",height:"100%"}
          };

          var chart = new google.visualization.PieChart(document.getElementById('stage_breakdown_piechart_div'));
          chart.draw(dataTable, chartOptions);
        }

        function drawStageBreakdownTreeMap(job) {
          var dataArray = [
            ['Stage Name', 'Parent Stage', 'Elapsed Time', 'Optional Color'],
            ['Global', null, 0, 0],
          ];

          $.each(job.stages, function(key, val) {
            dataArray.push( [ val.stageName, 'Global', val.elapsedTime, val.elapsedTime ]);
          });

          var dataTable = google.visualization.arrayToDataTable(dataArray);
          var tree = new google.visualization.TreeMap(document.getElementById('stage_breakdown_treemap_div'));
          tree.draw(dataTable, {
            maxColor: '#f00',
            midColor: '#ddd',
            minColor: '#0d0',
            headerHeight: 15,
            fontColor: 'black',
            showScale: true
          });
        }

        //Function to sort the element by total time, decreasing 
        function sortByTotalTime(a, b) {
            if(typeof(a[2]) == 'string') return -1;
            return b[2] - a[2];
        }

        function drawTransformPersistChars(job) {
            var persistenceChartData = [['Entity', '# of Records', 'Total Time']];
            var transformationChartData = [['Entity', '# of Records', 'Total Time']];

            var processorChartMap = {
                'PersistenceProcessor': persistenceChartData,
                'TransformationProcessor': transformationChartData
            };

            Array.prototype.indexOfField = function(index, value) {
                for(var i = 0; i < this.length; i++)
                if(this[i][index] === value)
                    return i;
                return -1;
            }
            
            var stagesForJob = getApiResource(API_URL + '/job/' + job._id + '/stage');

            $.each(stagesForJob, function(key, val) {
                var info = val.processingInformation;
                //Need to handle those records without processingInformation
                if(typeof (val.processingInformation) != 'undefined') {

                    var entity = val.processingInformation.split(",")[0].split("=")[1];

                    var chartData = processorChartMap[val.stageName];
                    if (chartData != null) {
                        //Initializing if dont exist
                        if(chartData.indexOfField(0, entity) == -1) {
                            chartData.push([entity, 0, 0]);
                        }

                        var persIndex = chartData.indexOfField(0, entity);
                        
                        //summing up all the time and number of records
                        val.metrics.forEach(function(mVal, index) {
                            chartData[persIndex][1] += mVal.recordCount;
                        });
                        chartData[persIndex][2] += val.elapsedTime;
                    }
                }
            }); 
                            
            var compareData = [['Entity', 'Persistence', 'Transformation']];
            
            var len = persistenceChartData.length;
            for(i = 1; i < len; i++) {
                var xformIndex = transformationChartData.indexOfField(0, persistenceChartData[i][0]);
                
                var persistencePR =0;
                var xformPR = 0;
                if(persistenceChartData[i][1] != 0)
                    persistencePR= persistenceChartData[i][2] / persistenceChartData[i][1];
                    
                if(transformationChartData[xformIndex][1] != 0)
                    xformPR = transformationChartData[xformIndex][2] / transformationChartData[xformIndex][1];
                    
                compareData.push([ persistenceChartData[i][0], persistencePR, xformPR ]);
            }
            
            persistenceChartData.sort(sortByTotalTime);
            transformationChartData.sort(sortByTotalTime);
            
            var persData = new google.visualization.arrayToDataTable(persistenceChartData);
            var xformData = new google.visualization.arrayToDataTable(transformationChartData);
            var compData = new google.visualization.arrayToDataTable(compareData);
            
            var persistenceChart = new google.visualization.BarChart(document.getElementById('persistence_div'));
            persistenceChart.draw(persData, {
                title : 'Entity Persistence Performance',
                width : 1800,
                height : 2000
            });

            var xformationChart = new google.visualization.BarChart(document.getElementById('xformation_div'));
            xformationChart.draw(xformData, {
                title : 'Entity Transformation Performance',
                width : 1800,
                height : 2000
            });

            var compChart = new google.visualization.ColumnChart(document.getElementById('compare_div'));
            compChart.draw(compData, {
                title : 'Transformation / Persistence Comparison',
                width : 1800,
                height : 2000
            });
        }
    </script>
    </head>
    <body>
        <div id="job_chooser">
            <h3>Available Jobs:</h3>
        </div>
        <div id="job_summary"></div>
        <div id="stage_breakdown_piechart_div"></div>
        <div id="stage_breakdown_treemap_div"></div>
        <div id="persistence_div"></div>
        <div id="xformation_div"></div>
        <div id="compare_div"></div>
    </body>
</html>