<html>
  <head>
    <title>Ingestion Job Report</title>

    <link rel="stylesheet" type="text/css" href="report.css" />
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript">

      var API_URL = 'http://localhost:8080';
      var MONGO_HOST_PORT = null; // defaults and set in html input
      
      google.load('visualization', '1', {'packages':['corechart']});

      google.setOnLoadCallback(listJobs);

      function listJobs() {
        $('#job_chooser').empty();

        MONGO_HOST_PORT = $('#mongo_host').val(); // initialize
        
        var jobs = getApiResource('/jobids');

        if (jobs != null) {
          $('#job_chooser').append('<h4>' + jobs.length + ' Available Jobs:</h4>');

          $.each(jobs, function(key, val) {
            $('#job_chooser')
              .append('<a href="#" onclick="jobSummary(\''+val._id+'\')">'+val._id+'</a> '+val.jobStartTimestamp+'<br/>');
          });
        }
      }

      function jobSummary(jobId) {
        $('#job_summary').empty().append('<h4>Job Summary: ' + jobId + '</h4>');

        var job = getApiResource('/job/' + jobId);

        var recordCount = getRecordCountForJob(job);
        job.recordCount = recordCount;

        var startDate = new Date(job.jobStartTimestamp);
        var stopDate = new Date(job.jobStopTimestamp);
        var jobTime = (stopDate.getTime() - startDate.getTime()) / 1000;

        $('#job_summary')
          .css({'color': 'white'})
          .append('Job Status: ' + job.status + '<br/>')
          .append('EdFi Record Count: ' +recordCount + '<br/>')
          .append('Total Job Time: ' + jobTime  + ' seconds' + '<br/>')
          .append('Total Job RPS: ' + (recordCount / jobTime).toFixed(2) + '<br/>');

        var errors = getApiResource('/job/' + jobId + '/error');
        $('#job_summary').append('Errors: ' + errors.length);

        drawStageBreakdownPieChart(job);

        drawTransformPersistChars(job);

      }

      function drawStageBreakdownPieChart(job) {
        var chartData = { 
          'cols': [ 
            { label: 'Stage Name', type: 'string'},
            { label: 'Elapsed Time', type: 'number'}
          ],
          'rows': []
        };

        $.each(job.stages, function(key, val) {
          var elapsedSeconds = val.elapsedTime/1000;
          chartData.rows.push({ c:[
              {v: val.stageName + '  ' + elapsedSeconds + 's  ' + Math.ceil(job.recordCount / elapsedSeconds) + 'rps'},
              {v: val.elapsedTime}
          ] });
        });

        var dataTable = new google.visualization.DataTable(chartData);
        var chartOptions = {
          pieSliceText: 'percent',
          sliceVisibilityThreshold: 0, // zero, otherwise it groups small slices into one
          width : 1500,
          height: 600,
          chartArea: { left:0, top:0, width:"100%", height:"100%"},
          legend: { textStyle: { color: '#eecc88' }},
          backgroundColor: '#333333',
          is3D: 'true'
        };

        var chart = new google.visualization.PieChart(document.getElementById('stage_breakdown_piechart_div'));
        chart.draw(dataTable, chartOptions);
      }

      function drawTransformPersistChars(job) {
          var persistenceChartData = [['Entity', 'Records', 'Time (ms)']];
          var transformationChartData = [['Entity', 'Records', 'Time (ms)']];

          var processorChartMap = {
              'PersistenceProcessor': persistenceChartData,
              'TransformationProcessor': transformationChartData
          };

          Array.prototype.indexOfField = function(index, value) {
              for(var i = 0; i < this.length; i++)
              if(this[i][index] === value)
                  return i;
              return -1;
          }
          
          var stagesForJob = getApiResource('/job/' + job._id + '/stage');

          $.each(stagesForJob, function(key, val) {
              var info = val.processingInformation;
              //Need to handle those records without processingInformation
              if(typeof (val.processingInformation) != 'undefined') {

                  var entity = val.processingInformation.split(",")[0].split("=")[1];

                  var chartData = processorChartMap[val.stageName];
                  if (chartData != null) {
                      //Initializing if dont exist
                      if(chartData.indexOfField(0, entity) == -1) {
                          chartData.push([entity, 0, 0]);
                      }

                      var persIndex = chartData.indexOfField(0, entity);
                      
                      //summing up all the time and number of records
                      val.metrics.forEach(function(mVal, index) {
                          chartData[persIndex][1] += mVal.recordCount;
                      });
                      chartData[persIndex][2] += val.elapsedTime;
                  }
              }
          });

          // add rps info to data label
          $.each(processorChartMap, function(key, val) {
              $.each(val, function(key2, val2) {
                  if (typeof val2[1] == 'number' && typeof val2[2] == 'number') {
                      val2[0] = val2[0] + ' (' + val2[1] + '/' + (val2[2]/1000) + ') = ' + Math.ceil(val2[1] / (val2[2]/1000));
                  }
              });
          });

          persistenceChartData.sort(sortByTotalTime);
          transformationChartData.sort(sortByTotalTime);
          
          var persData = new google.visualization.arrayToDataTable(persistenceChartData);
          var xformData = new google.visualization.arrayToDataTable(transformationChartData);

          var chartOptions = {
              titleTextStyle: { color: '#eecc88' },
              fontName: 'Arial Narrow',
              series: [{color:'#4466ff'},{color:'#ee0077'}],
              chartArea: {left: 0, width: '90%', height: '95%'},
              legend: {position: 'right', alignment: 'start', textStyle: { color: '#eecc88' }},
              hAxis: {textPosition: 'out', gridlines: { count: 0 }, textStyle: { color: 'white' } }, 
              vAxis: {textPosition: 'in', textStyle: { color: 'white' }},
              width : 1500,
              height : 1200,
              backgroundColor: '#333333'
          };
          
          var persistenceChart = new google.visualization.BarChart(document.getElementById('persistence_div'));
          chartOptions.title = 'Entity Persistence Performance',
          persistenceChart.draw(persData, chartOptions);

          var xformationChart = new google.visualization.BarChart(document.getElementById('xformation_div'));
          chartOptions.title = 'Entity Transformation Performance',
          xformationChart.draw(xformData, chartOptions);
      }

      function getApiResource(url) {
        var jsonData = $.ajax({
          url: API_URL + url,
          type: 'GET',
          headers: { 'X-Api-Version': MONGO_HOST_PORT },
          dataType: 'json',
          async: false
        }).responseText;
        return jQuery.parseJSON(jsonData);
      }

      function getRecordCountForJob(job) {
        var recordCount = 0;
        $.each(job.stages, function(key, val) {
          if (val.stageName == 'EdFiProcessor') {
            $.each(val.metrics, function(metricsKey, metricsVal) {
              recordCount += metricsVal.recordCount;
            });
          }
        });
        return recordCount;
      }

      //Function to sort the element by total time, decreasing 
      function sortByTotalTime(a, b) {
          if(typeof(a[2]) == 'string') return -1;
          return b[2] - a[2];
      }

    </script>
    </head>
    <body>
        <div id="mongo_chooser">
          <form onsubmit='listJobs();return false;'>
            (mongo_host:port) <input id="mongo_host" type="text" value="localhost:27017" size="30"/>
            <input type='submit'/>
          </form>
        </div>
        <div id="job_chooser"></div>
        <div id="job_summary"></div>
        <div id="stage_breakdown_piechart_div"></div>
        <div id="stage_breakdown_treemap_div"></div>
        <div id="persistence_div"></div>
        <div id="xformation_div"></div>
    </body>
</html>