<html>
  <head>
    <title>Ingestion Job Report</title>
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript">
    
    // Load the Visualization API and the piechart package.
    google.load('visualization', '1', {'packages':['corechart','treemap']});
      
    // Set a callback to run when the Google Visualization API is loaded.
    google.setOnLoadCallback(listJobs);

    function getApiResource(url) {
      var jsonData = $.ajax({
        url: url,
        dataType:"json",
        async: false
      }).responseText;
      return jQuery.parseJSON(jsonData);
    }

    function listJobs() {

      var jobs = getApiResource('http://localhost:8080/job');

      $.each(jobs, function(key, val) {
        $('#job_chooser').append('<a href="#" onclick="jobSummary(\''+val._id+'\')">'+val._id+'</a><br/>');
      });
    }

    function jobSummary(jobId) {
      $('#job_summary').empty().append('<h4>Job Summary: ' + jobId + '</h4>');

      var job = getApiResource('http://localhost:8080/job/' + jobId);

      var recordCount = getRecordCountForJob(job);

      var startDate = new Date(job.jobStartTimestamp);
      var stopDate = new Date(job.jobStopTimestamp);
      var jobTime = (stopDate.getTime() - startDate.getTime()) / 1000;

      $('#job_summary')
        .append('Job Status: ' + job.status + '<br/>')
        .append('EdFi Record Count: ' +recordCount + '<br/>')
        .append('Total Job Time: ' + jobTime  + ' seconds.' + '<br/>')
        .append('Total Job RPS: ' + (recordCount / jobTime).toFixed(2) + '<br/>');

      var errors = getApiResource('http://localhost:8080/job/' + jobId + '/error');
      $('#job_summary')
        .append('Errors: ' + errors.length);

      drawStageBreakdownPieChart(job);

      drawStageBreakdownTreeMap(job);

    }

    function getRecordCountForJob(job) {
      var recordCount = 0;
      $.each(job.stages, function(key, val) {
        if (val.stageName == 'EdFiProcessor') {
          $.each(val.metrics, function(metricsKey, metricsVal) {
            recordCount += metricsVal.recordCount;
          });
        }
      });
      return recordCount;
    }

    function drawStageBreakdownPieChart(job) {
      var chartData = { 
        'cols': [ 
          { label: 'Stage Name', type: 'string'},
          { label: 'Elapsed Time', type: 'number'}
        ],
        'rows': []
      };

      $.each(job.stages, function(key, val) {
        chartData.rows.push( { c:[ {v: val.stageName}, {v: val.elapsedTime, f: val.elapsedTime/1000 + ' seconds.' } ] });
      });

      var dataTable = new google.visualization.DataTable(chartData);
      var chartOptions = {
        title: 'Stage Breakdown: ' + job._id,
        pieSliceText: 'label',
        sliceVisibilityThreshold: 0,
        width: 1024,
        height: 768
      };

      var chart = new google.visualization.PieChart(document.getElementById('stage_breakdown_piechart_div'));
      chart.draw(dataTable, chartOptions);
    }

    function drawStageBreakdownTreeMap(job) {
      var dataArray = [
        ['Stage Name', 'Parent Stage', 'Elapsed Time', 'Optional Color'],
        ['Global', null, 0, 0],
      ];

      $.each(job.stages, function(key, val) {
        dataArray.push( [ val.stageName, 'Global', val.elapsedTime, val.elapsedTime ]);
      });

      var dataTable = google.visualization.arrayToDataTable(dataArray);
      var tree = new google.visualization.TreeMap(document.getElementById('stage_breakdown_treemap_div'));
      tree.draw(dataTable, {
        maxColor: '#f00',
        midColor: '#ddd',
        minColor: '#0d0',
        headerHeight: 15,
        fontColor: 'black',
        showScale: true
      });
    }

    </script>
  </head>

  <body>
    <div id="job_chooser">
      <h3>Available Jobs:</h3>
    </div>

    <div id="job_summary"></div>

    <div id="stage_breakdown_piechart_div"></div>

    <div id="stage_breakdown_treemap_div"></div>
  </body>
</html>